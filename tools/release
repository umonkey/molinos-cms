#!/bin/sh

DIR=$(dirname $0)

MCMS_VERSION=$(grep "define('MCMS_VERSION'" < $DIR/../lib/bootstrap.php | sed -e s"@define('MCMS_VERSION', '\|');@@g")

if [ -z "$MCMS_VERSION" ]; then
    echo "Unable to find version number in lib/bootstrap.php"
    exit 1
fi

if [ ! -d $DIR/svn/.svn ]; then
  echo "Please checkout dist/* as $DIR/svn, eg:"
  echo "$ svn checkout http://molinos-cms.googlecode.com/svn/dist/??? $DIR/svn"
  exit 1
fi

if [ ! -f $DIR/svn/modules.ini ]; then
  touch $DIR/svn/modules.ini
  svn add $DIR/svn/modules.ini
fi

git clean -fd

echo "Preparing Molinos CMS v$MCMS_VERSION"
zip -q9r molinos-cms-$MCMS_VERSION.zip \
  .htaccess.dist \
  *.php \
  conf/*.dist \
  doc \
  lib/*.php \
  lib/modules/admin \
  lib/modules/attachment \
  lib/modules/auth \
  lib/modules/base \
  lib/modules/install \
  lib/modules/nodeapi \
  lib/modules/pdo \
  lib/modules/update \
  themes

echo -n "Preparing modules: "
php -f tools/rebuild-modules.php $DIR/svn/modules.ini || exit 1

if [ -n "$(ls tmp/modules)" ]; then
    echo "done, uploading."

    for ZIP in tmp/modules/*.zip; do
        NAME=$(basename $ZIP)

        if [ $NAME -ne "*.zip" ]; then
            echo "$NAME: uploading."
            googlecode_upload.py -s $NAME -p molinos-cms -l Type-Module $ZIP
        fi
    done

    svn ci -m "Semi-automatic release." $DIR/svn
else
    echo "nothing new."
fi
