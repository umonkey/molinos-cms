#!/bin/sh

MCMS_VERSION=$(grep "define('MCMS_VERSION'" < lib/bootstrap.php | sed -e s"@define('MCMS_VERSION', '\|');@@g")

if [ -z "$MCMS_VERSION" ]; then
    echo "Unable to find version number in lib/bootstrap.php"
    exit 1
fi

git clean -fd

# syntax check
if [ -z $(which php) ]; then
    echo "PHP binary not found. Syntax check impossible, aborting."
    exit 1
else
    echo "Checking syntax of all php files."
    for file in $(find . -name '*.php' -o -name '*.phtml'); do
        php -l $file >phplint.log
        RES=$?
        if [ $RES -ne 0 -a $RES != 139 ]; then
            echo "ERROR: $RES"
            cat phplint.log && rm -f phplint.log && exit 1
        fi
    done
    rm -f phplint.log
fi

echo "Rebuilding class map"
php -f tools/rebuild-modmap.php

echo "Preparing Molinos CMS v$MCMS_VERSION"
zip -9rq molinos-cms-$MCMS_VERSION.zip .htaccess.dist *.php conf/*.dist doc lib/*.php lib/modules/{admin,auth,base,nodeapi,pdo,update} themes tools

echo "Preparing modules."
php -f tools/rebuild-modules.php || exit 1
for ZIP in modules/*.zip; do
    NAME=$(basename $ZIP)
    if [ -n "$(HEAD http://code.google.com/p/molinos-cms/downloads/detail?name=$NAME | grep '404 Not Found')" ]; then
        echo "$NAME: uploading."
        googlecode_upload.py -s $NAME -p molinos-cms -l Type-Module $ZIP
    else
        echo "$NAME is already there."
    fi
done
cp modules/modules.ini ../molinos-cms.svn/dist/8.05/ && \
svn ci -m "Semi-automatic release." ../molinos-cms.svn/dist/8.05/
