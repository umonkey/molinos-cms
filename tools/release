#!/bin/sh

DIR=$(dirname $0)

MCMS_VERSION=$(grep "define('MCMS_VERSION'" < $DIR/../lib/bootstrap.php | sed -e s"@define('MCMS_VERSION', '\|');@@g")
MCMS_RELEASE=$(echo $MCMS_VERSION | sed -re 's/^([0-9]+\.[0-9]+).*/\1/g')

if [ -z "$MCMS_VERSION" ]; then
    echo "Unable to find version number in lib/bootstrap.php"
    exit 1
fi

if [ ! -d $DIR/svn/.svn ]; then
  echo "Please checkout dist/ as $DIR/svn, eg:"
  echo "$ svn checkout https://molinos-cms.googlecode.com/svn/dist/ $DIR/svn"
  exit 1
fi

if [ ! -f $DIR/svn/$MCMS_RELEASE/modules.ini ]; then
  touch $DIR/svn/$MCMS_RELEASE/modules.ini
  svn add $DIR/svn/$MCMS_RELEASE/modules.ini
fi

git clean -fd

echo "Preparing Molinos CMS v$MCMS_VERSION"
zip -q9r molinos-cms-$MCMS_VERSION.zip \
  .htaccess.dist \
  *.php \
  conf/*.dist \
  doc \
  lib/*.php \
  lib/modules/admin \
  lib/modules/attachment \
  lib/modules/auth \
  lib/modules/base \
  lib/modules/install \
  lib/modules/modman \
  lib/modules/nodeapi \
  lib/modules/phtml \
  lib/modules/pdo \
  lib/modules/update \
  themes

echo -n "Preparing modules: "
php -f tools/rebuild-modules.php $DIR/svn/$MCMS_RELEASE/modules.ini || exit 1

echo "done, uploading."

for ZIP in tmp/modules/*.zip; do
    if [ -f "$ZIP" ]; then
        NAME=$(basename $ZIP)
        INFO=$(echo "$ZIP" | sed -e 's@.*/@@g' | sed -e 's/^\([^-]*\)-/\1 v/g' | sed -e 's/\.zip$//g')
        echo "$NAME: uploading."
        googlecode_upload.py -s "$INFO" -p molinos-cms -l Type-Module,R${MCMS_RELEASE},Deprecated $ZIP
    fi
done

svn ci -m "Semi-automatic release." $DIR/svn
