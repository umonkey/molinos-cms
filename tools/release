#!/bin/sh

DIR=$(dirname $0)

php -f ${DIR}/rebuild-registry.php
. $DIR/changelogs

MCMS_VERSION=$(php -r 'require "'$DIR'/../lib/modules/core/class.loader.php"; echo MCMS_RELEASE; ')
if [ -z "$MCMS_VERSION" ]; then
    echo "Unable to determine version number."
    exit 1
fi

if [ ! -d $DIR/svn/.svn ]; then
  echo "Please checkout dist/* as $DIR/svn, eg:"
  echo "$ svn checkout http://molinos-cms.googlecode.com/svn/dist/??? $DIR/svn"
  exit 1
fi

if [ ! -f $DIR/svn/modules.ini ]; then
  touch $DIR/svn/modules.ini
  svn add $DIR/svn/modules.ini
fi

git clean -fd

echo "Preparing Molinos CMS v$MCMS_VERSION"
zip -q9r molinos-cms-$MCMS_VERSION.zip \
  .htaccess.dist \
  *.php \
  doc \
  lib/modules/admin \
  lib/modules/attachment \
  lib/modules/auth \
  lib/modules/base \
  lib/modules/core \
  lib/modules/cron \
  lib/modules/install \
  lib/modules/markdown \
  lib/modules/modman \
  lib/modules/nodeapi \
  lib/modules/pdo \
  lib/modules/schema \
  lib/modules/xslt \
  sites/default

echo -n "Preparing modules: "
php -f tools/rebuild-modules.php ${DIR}/svn/${MCMS_VERSION}/modules.ini || exit 1

echo "done, uploading."

for ZIP in tmp/modules/*.zip; do
    if [ -f "$ZIP" ]; then
        NAME=$(basename $ZIP)
        echo "$NAME: uploading."
        googlecode_upload.py -s $NAME -p molinos-cms -l Type-Module,R${MCMS_VERSION} $ZIP
    fi
done

svn ci -m "Semi-automatic release." $DIR/svn
git tag -f lastrelease-master

echo "http://code.google.com/p/molinos-cms/downloads/list?can=2&q=label%3AR9.03+label%3AType-Module"
