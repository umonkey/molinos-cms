#!/bin/sh

MCMS_VERSION=$(grep "define('MCMS_VERSION'" < lib/bootstrap.php | sed -e s"@define('MCMS_VERSION', '\|');@@g")

if [ -z "$MCMS_VERSION" ]; then
    echo "Unable to find version number in lib/bootstrap.php"
    exit 1
fi

git clean -fd

echo "Preparing Molinos CMS v$MCMS_VERSION"
zip -9r molinos-cms-$MCMS_VERSION.zip \
  .htaccess.dist \
  *.php \
  conf/*.dist \
  doc \
  lib/*.php \
  lib/modules/admin \
  lib/modules/attachment \
  lib/modules/auth \
  lib/modules/base \
  lib/modules/install \
  lib/modules/nodeapi \
  lib/modules/pdo \
  lib/modules/update \
  themes \
  tools

echo "Preparing modules."
php -f tools/rebuild-modules.php || exit 1
for ZIP in modules/*.zip; do
    NAME=$(basename $ZIP)
    if [ -n "$(HEAD http://code.google.com/p/molinos-cms/downloads/detail?name=$NAME | grep '404 Not Found')" ]; then
        echo "$NAME: uploading."
        googlecode_upload.py -s $NAME -p molinos-cms -l Type-Module $ZIP
    else
        echo "$NAME is already there."
    fi
done
cp modules/modules.ini ../molinos-cms.svn/dist/8.05/ && \
svn ci -m "Semi-automatic release." ../molinos-cms.svn/dist/8.05/
