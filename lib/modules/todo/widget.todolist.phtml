<form id='todosubmitform' method='post' action='<?php print l('?q=todo.rpc&amp;action=add&amp;destination=CURRENT'); ?>'>
<input type='hidden' name='rel' value='<?php print $rel; ?>' />
<input id='todotext' type='text' name='name' />
<input type='submit' value='добавить' class='submit' />
<div class='hint'>Текст напоминания, например: «Починить javascript на www.molinos.ru — не работает меню»</div>
<?php print show_users($users); ?>
<div class='hint'>Если заметка не для тебя — выбери получателя</div>
</form>
<?php

function show_todo(array $list, $type, $title, $linktpl)
{
  print mcms::html('h3', array(
    'class' => "cold todolist {$type}". (empty($list[$type]) ? ' empty' : ''),
  ), mcms::html('span', $title));

  if ('open' == $type)
    print mcms::html('p', array(
      'class' => 'todolist emptymsg '. $type .' '. (empty($list[$type]) ? '' : 'hide'),
      ), 'Этот список пока пуст.  Вам нужно добавить или изменить задание, тогда здесь что-нибудь появится.');

  print "<table class='todolist {$type}'>";

  if (!empty($list[$type])) {
    foreach ($list[$type] as $task) {
      $link = str_replace('$nid', $task['id'], $linktpl);

      $row = mcms::html('td', mcms::html('input', array(
        'type' => 'checkbox',
        'value' => $task['id'],
        )));
      $row .= mcms::html('td', mcms::html('span', array(
        'class' => 'delete',
        )));
      $row .= mcms::html('td', l($link, mcms_plain($task['name'])));

      if (mcms::user()->id == $task['uid']['id'])
        $row .= mcms::html('td');
      else {
        $re = l($task['uid'], null, array('class' => 'userlink'));
        $row .= mcms::html('td', $re);
      }

      print mcms::html('tr', array(
        'id' => $task['id'],
        ), $row);
    }
  }

  print '</table>';
}

function show_users(array $list)
{
  $output = '';

  foreach ($list as $id => $name)
    $output .= mcms::html('option', array(
      'value' => $id,
      'selected' => ($id == mcms::user()->id) ? 'selected' : '',
      ), $name);

  $html = mcms::html('select', array(
    'id' => 'todouser',
    'name' => 'user',
    ), $output);

  return mcms::html('div', array(
    'class' => 'todo-setuser',
    ), $html);
}

$text = 'TODO'. ($relname ? ' &rarr; '. l("/node/{$rel}/", $relname) : '');
show_todo($list, 'open', $text, $linktpl);

show_todo($list, 'closed', 'Выполненные задачки', $linktpl);
